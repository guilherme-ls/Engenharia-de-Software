<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Dica da Árvore</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .hint-label {
            color: #b7c8a1;
            background: #3d5c36;
            border-radius: 8px;
            padding: 4px 16px;
            font-size: 1rem;
            margin-bottom: 14px;
            font-weight: bold;
        }
        .hint {
            color: #3d5c36;
            font-size: 1.1rem;
            margin-bottom: 18px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">DICA</div>
        <div class="card">
            <div class="hint-label" id="hint-label" style="cursor:pointer;" onclick="nextHint()">NOVA DICA &gt;</div>
            <div class="hint" id="hint-text"></div>
            <div class="bottom-btn" style="margin-top:auto;">
                <button id="search-btn">ENCONTREI</button>
            </div>
        </div>
        <!-- Temperature bar and label moved below the card -->
        <div id="proximity-container" style="width:88%;max-width:320px;display:flex;flex-direction:column;align-items:center;margin-top:18px;">
            <div style="width:100%;">
                <div style="width:100%;height:18px;background:#b7c8a1;border-radius:9px;overflow:hidden;">
                    <div id="proximity-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#2196f3,#f44336);transition:width 0.5s,background 0.5s;"></div>
                </div>
            </div>
            <div style="margin-top:8px;color:#3d5c36;font-size:1.1rem;font-weight:bold;">Temperatura</div>
        </div>
    </div>
    <script>
        let hints = [];
        let hintIndex = 0;
        let treeNumber = null;
        let treeCoords = null;
        let proximityWatchId = null;
        let hasShownGeoAlert = false;

        function nextHint() {
            if (hints.length === 0) return;
            hintIndex = (hintIndex + 1) % hints.length;
            document.getElementById('hint-text').innerText = hints[hintIndex];
        }

        async function fetchTreeCoords(numtree) {
            if (!numtree) return;
            const res = await fetch('/api/tree_by_number/' + numtree);
            if (!res.ok) return;
            const tree = await res.json();
            // Always return the coordinates object or null
            if (tree.coordinates && typeof tree.coordinates.lat === "number" && typeof tree.coordinates.lng === "number") {
                return { lat: tree.coordinates.lat, lng: tree.coordinates.lng };
            } else {
                return null;
            }
        }

        function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
            // Haversine formula with correct radian conversion
            const R = 6371000; // meters
            const toRad = x => x * Math.PI / 180;
            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        function interpolateColor(distance, minDistance, maxDistance) {
            // t=0 (far) is blue, t=1 (close) is red
            let t;
            if (distance <= minDistance) t = 1;
            else if (distance >= maxDistance) t = 0;
            else t = 1 - ((distance - minDistance) / (maxDistance - minDistance));
            // Clamp t between 0 and 1
            t = Math.max(0, Math.min(1, t));
            // Blue:   33,150,243
            // Red:   244,67,54
            const r = Math.round(33 + (244 - 33) * t);
            const g = Math.round(150 + (67 - 150) * t);
            const b = Math.round(243 + (54 - 243) * t);
            return `rgb(${r},${g},${b})`;
        }

        function updateProximityBar(distance, userLat, userLng, treeLat, treeLng) {
            const maxDistance = 100;
            const minDistance = 5;
            let percent;
            if (distance <= minDistance) {
                percent = 100;
            } else if (distance >= maxDistance) {
                percent = 0;
            } else {
                percent = 100 - ((distance - minDistance) / (maxDistance - minDistance)) * 100;
            }
            percent = Math.max(0, Math.min(100, percent));
            const color = interpolateColor(distance, minDistance, maxDistance);
            const bar = document.getElementById('proximity-bar');
            bar.style.width = percent + "%";
            bar.style.background = color;

            // Debugging output
            console.log(
                `[DEBUG] User/Tree positions:`,
                `User(lat,lon):`, userLat, userLng,
                `Tree(lat,lon):`, treeLat, treeLng,
                `Distance:`, distance.toFixed(2), 'meters',
                `Bar:`, percent.toFixed(1) + '%',
                `Color:`, color
            );
        }

        function startProximityWatch() {
            if (!navigator.geolocation) {
                if (!hasShownGeoAlert) {
                    alert("Geolocalização não suportada ou permitida no seu navegador.");
                    hasShownGeoAlert = true;
                }
                return;
            }
            function tryStart() {
                if (treeCoords && typeof treeCoords.lat === "number" && typeof treeCoords.lng === "number") {
                    if (proximityWatchId !== null) {
                        navigator.geolocation.clearWatch(proximityWatchId);
                    }
                    proximityWatchId = navigator.geolocation.watchPosition(
                        function(pos) {
                            if (!pos || !pos.coords) {
                                if (!hasShownGeoAlert) {
                                    alert("Não foi possível obter sua posição. Certifique-se de que o GPS está ativado e que você está em um local com sinal.");
                                    hasShownGeoAlert = true;
                                }
                                console.warn("[DEBUG] Geolocation position unavailable:", pos);
                                updateProximityBar(0, undefined, undefined, treeCoords.lat, treeCoords.lng);
                                return;
                            }
                            const userLat = pos.coords.latitude;
                            const userLng = pos.coords.longitude;
                            const treeLat = treeCoords.lat;
                            const treeLng = treeCoords.lng;
                            console.log("[DEBUG] Geolocation success:", pos);
                            const distance = getDistanceFromLatLonInMeters(userLat, userLng, treeLat, treeLng);
                            updateProximityBar(distance, userLat, userLng, treeLat, treeLng);
                        },
                        function(err) {
                            const treeLat = treeCoords.lat;
                            const treeLng = treeCoords.lng;
                            updateProximityBar(0, undefined, undefined, treeLat, treeLng);
                            console.error("[DEBUG] Geolocation error:", err);
                            if (!hasShownGeoAlert) {
                                if (err.code === 1) {
                                    alert("Permissão de localização negada. Ative a localização.");
                                } else if (err.code === 2) {
                                    alert("Não foi possível obter sua posição. Certifique-se de que o GPS está ativado e que você está em um local com sinal.");
                                } else if (err.code === 3) {
                                    alert("Tempo esgotado ao tentar obter localização.");
                                }
                                hasShownGeoAlert = true;
                            }
                        },
                        { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
                    );
                } else {
                    setTimeout(tryStart, 200);
                }
            }
            tryStart();
        }

        async function loadTree() {
            const res = await fetch('/api/random_tree');
            const tree = await res.json();
            hints = tree.hints;
            treeNumber = tree.number;
            hintIndex = 0;
            document.getElementById('hint-text').innerText = hints[hintIndex];
            document.getElementById('search-btn').onclick = function() {
                window.location.href = '/search?numtree=' + treeNumber;
            };
            sessionStorage.setItem('selected_tree_number', treeNumber);
            treeCoords = await fetchTreeCoords(treeNumber);
            startProximityWatch();
        }

        loadTree();
    </script>
</body>
</html>
